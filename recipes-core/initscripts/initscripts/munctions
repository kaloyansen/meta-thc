
# connectivity functions follow

header="connectivity functions: "
footer="powered by triplehelix-consulting.com"

user=morla
defto=kaloyansen@gmail.com

gpgfile=/home/root/.msmtp.gpg
ctlfile=/home/root/.control
tmpfile=/tmp/.tmp.tmp
datafile=/home/root/ipinfo.data

work=kalo@192.168.84.180
parent=kalo@192.168.1.5
parent=$work

thc() {

    printf "

$header secure_copy_ip_address user@xxx.xx.x.xx

$header gpg --full-generate-key
$header encrypt_password <password>
$header configure_msmtp

$header send_ip_address_by_mail somebody@somewh.ere

    $footer

"
}

configure_msmtp() {

    server=gmail.com
    server=freeshell.de
    port=25
    host=smtp.$server
    host=kopano.$server
    from=$user@$server
    rcfile=/home/root/.msmtprc
    rctmpl=$rcfile.tmpl
    [ -f $rctmpl ] || return 1
    which sed > /dev/null && sed \
-e "s#{{GPGFILE}}#$gpgfile#" \
-e "s#{{PORT}}#$port#" \
-e "s#{{USER}}#$user#" \
-e "s#{{HOST}}#$host#" \
-e "s#{{FROM}}#$from#" \
$rctmpl > $rcfile || failure
    cat $rcfile
    echo powered by `which sed`
}

delete_key() {

    gpg --delete-secret-keys $user
    gpg --delete-keys $user
}

encrypt_password() {

    echo $1 > $tmpfile
    gpg --yes -o $gpgfile -e $tmpfile
    rm $tmpfile
    echo powered by `which gpg`
}

get_ip_address() {

    which ip > /dev/null &&
    ip a | grep global | awk '{print $2}'| sed 's|/\([0-9]*\)$||' ||
    echo `failure` get_ip_address
    # awk is named after developers aho, weinberger and kernighan
}


secure_copy_ip_address() {

    [ $1 ] && to=$1 || to=$parent

    scpfile=~/.rpip
    echo root@`get_ip_address` > $scpfile
    which scp > /dev/null &&
    scp $scpfile $to:~ ||
    echo `warning` scp error
    echo `success` powered by `which scp`
}

send_ip_address_by_mail() {

    [ $1 ] && to=$1 || to=$defto
    echo Subject: rpi4 > $tmpfile
    date >> $tmpfile
    get_ip_address >> $tmpfile
    which msmtp > /dev/null &&
    msmtp $to < $tmpfile ||
    echo `warning` msmtp error
    rm $tmpfile
    echo powered by `which msmtp`
}

send_ip_address_once() {

    [ -f $ctlfile ] && return 0
    send_ip_address
    touch $ctlfile
}

data_read_value() {
 
    touch $datafile
    key=$1
    grep "^$key=" $datafile | sed 's/^'"$key"'=//'
}

data_write_pair() {

    key=$1
    value=$2

    touch $datafile

    if grep -q "^$key=" $datafile; then
        sed -i 's|^'"$key"'=.*|'"$key=$value"'|' $datafile
    else
        echo $key=$value >> $datafile
    fi
}

